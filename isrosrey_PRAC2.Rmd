---
title: "Práctica 2: Limpieza y validación de los datos"
author: "Ismael Rosende Rey"
date: "26/12/2020"
output:
  pdf_document: 
    toc: yes
    toc_depth: 3
toc-title: "Índice"
---

```{r load_libraries, include=FALSE}
library(dplyr)
```

\pagebreak
## 1. Descripción del dataset

Se utiliza el dataset sugerido en el enunciado de la competición de Kaggle, basado
en el hundimiento del titanic. Este dataset se divide en dos csv, uno con 891 filas
que contienen la información completa de los pasajeros, indicando si han sobrevivido
o no, y otro con 418 filas que contiene la misma información execpto el dato de supervivencia.

Esta competición consiste en preparar un modelo que predice si un pasajero ha
sobrevivido o ha muerto en base a la información disponible. El fichero "train.csv"
contiene 12 columnas con los siguientes campos acerca de los pasajeros, mientras
que el fichero "test.csv" contiene 11 columnas al no disponer de la columna de
supervivencia:

* **PassengerId**: Identificador único asociado a cada pasajero.
* **Survival (0=No, 1=Yes)**: Indica si ha sobrevivido.
* **Pclass (1=1st, 2=2nd, 3=3rd)**: Clase en la que viajaba.
* **Name**: Nombre completo del pasajero.
* **Sex**: Si se trataba de un hombre o mujer.
* **Age**: Edad en años.
* **Sibsp**: Número de hermanos / esposas abordo del barco.
* **Parch**: Número de padres / niños abordo del barco.
* **Ticket**: Número del ticket.
* **Fare**: Tarifa que ha pagado por el ticket.
* **Cabin**: Número de cabina.
* **Embarked (C=Cherbourg, Q=Queenstown, S=Southampton)**: Puerto de embarcación.

Este dataset está creado con fines educativos en la plataforma Kaggle, y mediante
su análisis se pretende encontrar qué factores fueron determinantes en el momento
del accidente para que determinadas personas sobreviviesen o muriesen. De esta forma,
se podrían determinar posibles mejoras en el diseño del barco que aumenten las
posibilidades de supervivencia de los pasajeros en caso de que la tragedia se repita.
También podría ser útil para recomendar a los pasajeros que tipo de ticket 
(primera clase, segunda o tercera) sería el más recomendable para ellos.

## 2. Integración y selección de datos

Comenzamos leyendo los ficheros de datos para luego integrar y seleccionar los
campos de interés:

```{r}
train_data <- read.csv("./data/train.csv")
test_data <- read.csv("./data/test.csv", stringsAsFactors = TRUE)
```

Integramos los datos en un único dataset para tener en consideración toda la
información durante la limpieza de los datos:

```{r}
# Unimos los datos de entrenamiento y prueba
merged_data  <- bind_rows(train_data, test_data)
str(merged_data)
```
```{r}
summary(merged_data)
```


Se considera que todas las columnas pueden aportar información de interés y no
se descarta ninguna de ellas. El campo "PassengerId" no será útil para determinar
si un pasajero sobrevive o muere, pero se usará para recomponer los bloques de
entrenamiento y test originales al finalizar la limpieza de los datos.
Sin embargo, sí podemos crear algún campo adicional que podría ser útil, por ejemplo,
un campo que indique si el pasajero es adulto o no, pero lo haremos tras limpiar
los datos, ya que el campo "Age" tiene muchos registros sin imputar.

## 3. Limpieza de datos

Comprobamos que campos podrían convertirse a factor. Para ello contamos las
diferencias en los valores que contienen sus filas:

```{r}
sapply(merged_data, function(x) length(unique(x)))
```

Vemos que los campos "Survived", "Pclass", "Sex", "Embarked" son susceptibles de
conversión al tener pocos valores asociados (menos de 4 en estos casos).
Por tanto los convertimos a tipo factor:

```{r}
merged_data$Survived <- as.factor(merged_data$Survived)
merged_data$Pclass <- as.factor(merged_data$Pclass)
merged_data$Sex <- as.factor(merged_data$Sex)
merged_data$Embarked <- as.factor(merged_data$Embarked)
```

Una vez tenemos los campos con el tipo deseado, analizamos qué hacer con los
elementos perdidos. Como hemos visto en el resumen de los datos del apartado
anterior, existen NAs en las variables "Age" y "Fare" (además de la variable
"Survived" que ya sabemos que los datos de test omitían este daot),
pero también necesitamos comprobar si hay elementos en blanco:

```{r}
colSums(merged_data == "")
```

Además de los NAs de las variables anteriores, tenemos valores vacíos en las
variables "Cabin" y "Embarked". Observando los datos ordenados por el Cabin,
nos damos cuenta que los pasajeros con Cabin B19 al B26 han embarcado por la
puerta de Southampton, por tanto, suponemos que a los 2 valores vacíos que
tenían la cabina B28 asiganda, les correspondería entrar por la puerta S también.

## Velo Con un gráfico??

```{r}
merged_data$Embarked[merged_data$Embarked == ""] <- "S"
```

Una vez hemos completado la variable "Embarked" vamos a asignar la media de la
edad de las mujeres y la de los hombres a los pasajeros que no tienen este dato:

```{r}
# Hallamos la media de la edad de las mujeres y de los hombres
femaleMeanAge <- mean(merged_data$Age[merged_data$Sex == "female"], na.rm=T)
maleMeanAge <- mean(merged_data$Age[merged_data$Sex == "male"], na.rm=T)
# Se asigna la media correspondiente a cada grupo 
merged_data$Age[is.na(merged_data$Age) & merged_data$Sex == "female"] <- femaleMeanAge
merged_data$Age[is.na(merged_data$Age) & merged_data$Sex == "male"] <- maleMeanAge
# Se comprueba que no quedan valores sin asignar
sum(is.na(merged_data$Age))
```
También asignamos la media al valor perdido de "Fare", aunque al ser un único
registro, probablemente no varíe mucho el resultado del modelo.

```{r}
merged_data$Fare[is.na(merged_data$Fare)] <- mean(merged_data$Fare, na.rm=T)
# Se comprueba que no quedan valores nulos
sum(is.na(merged_data$Fare))
```



```{r}
which(is.na(merged_data$Fare))
train_data[train_data$Embarked == "", ]
```

```{r}
# Al finalizar la limpieza de datos con el dataset completo, restauramos los bloques
# de entrenamiento y test con los datos ya limpios usando el passengerId
cleaned_train <- merged_data[merged_data$PassengerId %in% c(1:891), ]
cleaned_test <- merged_data[merged_data$PassengerId %in% c(892:1309), ]
```


## 4. Análisis de los datos

## 5. Resultados

## 6. Conclusiones




```{r table2, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|        Contribuciones        | Firma    |
|------------------------------|:--------:|
| Investigación previa         | isrosrey |
| Redacción de las respuestas  | isrosrey |
| Desarrollo código            | isrosrey |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```